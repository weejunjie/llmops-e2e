name: CI - Build, Scan, Deploy to k3d

on:
  push:
    branches: [main]

env:
  IMAGE_NAME: fastapi-app
  IMAGE_TAG: latest
  LOCAL_IMAGE: fastapi-app:latest # local tag for k3d

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repo
      - uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Build Docker image locally (no push)
      - name: Build Docker image locally
        uses: docker/build-push-action@v6
        with:
          context: ./
          file: ./Dockerfile
          push: false
          tags: ${{ env.LOCAL_IMAGE }}

      # 4. Run Trivy scan on local image
      - name: Trivy scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.LOCAL_IMAGE }}
          format: table
          exit-code: "0"
          severity: HIGH,CRITICAL
          timeout: 60m

      # 5. Install k3d
      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d version

      # 6. Create k3d cluster
      - name: Create k3d cluster
        run: |
          k3d cluster create ci-cluster --agents 1 --wait
          kubectl cluster-info

      # 7. Load local image into k3d
      - name: Load Docker image into k3d
        run: |
          k3d image import ${{ env.LOCAL_IMAGE }} --cluster ci-cluster

      # 8. Deploy to k3d cluster
      - name: Deploy to k3d cluster
        run: |
          # Make sure your deployment.yaml uses the local image tag
          sed -i 's|image: junjiewee/fastapi-app:latest|image: fastapi-app:latest|g' deployment.yaml
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

      # 9. Show deployed resources
      - name: Show deployed resources
        run: |
          kubectl get deploy
          kubectl get svc
